tosca_definitions_version: tosca_2_0

metadata:

  template_name: Khutulun Hello World Example
  template_author: Khutulun

imports:

- namespace: kh
  url: khutulun/profile.yaml

topology_template:

  node_templates:

    endpoint:
      type: kh:Endpoint
      requirements:
      - connection: frontend

    frontend:
      type: kh:LoadBalancer
      requirements:
      - connection: web-server

    web-server:
      type: kh:Container
      properties:
        count: 3
      capabilities:
        runnable:
          properties:
            image:
              reference: docker.io/nginx:1.21.6
        connectable:
          attributes:
            ports:
            - internal: 80
              protocol: TCP
      requirements:
      - connection:
          node: database
          relationship:
            type: kh:IPPort
          # event: reconfigure

    database:
      type: kh:Container
      capabilities:
        runnable:
          properties:
            image:
              reference: docker.io/postgres:14.2
            create-arguments: [ --env=POSTGRES_PASSWORD=postgres ]
          attributes:
            host: lab1
      requirements:
      - storage: directory

    directory:
      type: kh:LocalDirectory
      capabilities:
        storage:
          properties:
            temporary: true

  policies:

    - podman:
        type: kh:Run
        properties:
          runner: podman
        targets:
        - frontend
        - web-server
        - database

    - colocate:
        type: kh:Placement
        properties:
          hints: [ Colocate ]
        targets:
        - frontend
        - web-server
